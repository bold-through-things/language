local myURL
	pls do URL
		string "https://example.com/path?query=123"

pls do print
	pls get pathname from myURL

pls do print
	string "\n--- Testing TextEncoder/TextDecoder ---"

local encoder
	pls do TextEncoder

local decoder
	pls do TextDecoder

local text_tests
	list
		type named str
		string "ASCII text"
		string "Unicode: ðŸ¦• Deno"
		string "Numbers: 42"

solution
	point loops each text
		pls get text_tests
		
	local bytes
		pls do encode the encoder
			pls get text

	local restored
		pls do decode the decoder
			pls get bytes

	pls do print
		string `Text: "`
		pls get text
		string `" -> Bytes: [`
		pls get bytes
		string `] -> Restored: "`
		pls get restored

pls do print
	string "\n--- Testing atob/btoa ---"

local testString
	string "Hello World"

local encodedString
	pls do btoa
		pls get testString

local decodedString
	pls do atob
		pls get encodedString

pls do print
	string "Original: "
	pls get testString
	string " -> Encoded: "
	pls get encodedString
	string " -> Decoded: "
	pls get decodedString

pls do print
	string "\n--- Testing JSON.stringify/parse ---"

local testObj
	dict
		type named str for K
		type named str for V
		entry
			string "name"
			string "Claude"
		entry
			string "type"
			string "AI"
		entry
			string "version"
			string "42"

local jsonString
	pls do str:JSON the testObj

local parsedObj
	type named dict
		type named str for K
		type named 67lang:unknown for V
	pls do JSON:str the jsonString

pls do print
	string "Original object -> JSON: "
	pls get jsonString

pls do print
	string "Parsed back -> name: "
	pls do # the parsedObj
		string "name"

pls do print
	string "\n--- Testing fetch (data URL) ---"

pls do fetch as response
	string "data:application/json,{"67lang": "is fucking awesome"}"
	note the params
	dict
		type named str for K
		type named str for V

pls do print
	pls get response
	pls get json from response

type named MyEncoder is JS:object
	constructor TextEncoder

type named MyUint8Array is JS:object
	constructor Uint8Array

note TODO just honestly remove these here
fn encode is PrototypeCall
	sync
	constructor TextEncoder
	fn encode
	param self
		type named MyEncoder
	param input
		type named str
	returns
		type named MyUint8Array

local encoder2
	pls do MyEncoder

pls do print
	string "\n--- Testing custom MyEncoder ---"
	pls do encode
		pls get encoder2
		string "Custom encoding works!"
