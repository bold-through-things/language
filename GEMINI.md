refactoring. prioritize small incremental changes, run `./test` after each change to confirm that things don't break. the code is quite complex and easy to break, and hard to fix afterwards.
